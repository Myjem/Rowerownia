<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Bicycles</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
  <h1 class="text-center">List of All Bicycles</h1>
  <table class="table table-striped mt-4">
    <thead>
    <tr>
      <th>Select</th>
      <th>Name</th>
      <th>Size</th>
      <th>Price</th>
      <th>Status</th>
    </tr>
    </thead>
    <tbody id="bicycleTable">
    </tbody>
  </table>
  <div class="mb-3">
    <label for="startDate" class="form-label">Start Date</label>
    <input type="date" class="form-control" id="startDate" required>
  </div>
  <div class="mb-3">
    <label for="endDate" class="form-label">End Date</label>
    <input type="date" class="form-control" id="endDate" required>
  </div>
  <button class="btn btn-primary" onclick="reserveBikes()">Reserve</button>
  <div id="message" class="mt-3"></div>
</div>

<script>
  let selectedBikes = [];
  let loggedUserId = null;

  document.addEventListener('DOMContentLoaded', async function() {
    await fetchLoggedUser();
    await fetchBikes();
  });

  async function fetchLoggedUser() {
    try {
      const token = localStorage.getItem("token");
      const response = await fetch('/api/v1/auth/user/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const user = await response.json();
        loggedUserId = user.userId;
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
    }
  }

  async function fetchBikes() {
    try {
      const response = await fetch('/api/v1/bike');
      if (response.ok) {
        const bikes = await response.json();
        const tableBody = document.getElementById('bicycleTable');
        bikes.forEach(bike => {
          if (bike.bikeName !== "deleted_Bike" && !bike.isBroken) {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><input type="checkbox" class="bikeCheckbox" value="${bike.bikeId}"></td>
              <td>${bike.bikeName}</td>
              <td>${bike.bikeSize}</td>
              <td>${bike.bikePrice}</td>
              <td>Available</td>
            `;
            tableBody.appendChild(row);
          }
        });
      } else {
        showMessage('Failed to fetch bicycles from the server.', 'danger');
      }
    } catch (error) {
      showMessage(`Error: ${error.message}`, 'danger');
    }
  }

  function reserveBikes() {
    const checkboxes = document.querySelectorAll('.bikeCheckbox:checked');
    selectedBikes = Array.from(checkboxes).map(cb => parseInt(cb.value));

    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const today = new Date().toISOString().split('T')[0];

    if (!startDate || !endDate || selectedBikes.length === 0) {
      showMessage('Please select bikes and dates.', 'danger');
      return;
    }

    const token = localStorage.getItem("token");

    fetch('/api/v1/auth/user/bikeBooking/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        userId: loggedUserId,
        bikeIds: selectedBikes,
        bookingDate: today,
        startDate: startDate,
        endDate: endDate
      })
    })
            .then(response => {
              if (!response.ok) {
                return response.text().then(text => { throw new Error(`Error ${response.status}: ${text}`); });
              }
              return response.text(); // Nie zakładaj, że odpowiedź to JSON
            })
            .then(text => {
              try {
                const data = JSON.parse(text); // Sprawdzenie, czy odpowiedź to JSON
                showMessage(data.message || 'Bikes reserved successfully!', 'success');
              } catch (error) {
                showMessage('Bikes reserved successfully!', 'success'); // Zakładamy, że odpowiedź była pusta
              }
            })
            .catch(error => {
              console.error("Booking error:", error);
              showMessage(`Error: ${error.message}`, 'danger');
            });
  }

  function showMessage(message, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
